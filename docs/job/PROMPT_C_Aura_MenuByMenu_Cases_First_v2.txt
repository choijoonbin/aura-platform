[C) Aura/Agent Prompt] Case Detail 탭(Agent Stream/RAG/Similar/Confidence) 실데이터 연결 최소 구현(P0-P2)
(HITL 우선, 자동 실행 제외)

파일 경로/생성 파일명:
- (수행 후 산출) docs/prompts/PHASE_Cases_Aura_Bindings_P0-P2.md
- (코드 변경) aura-platform-main 기준 services/streaming/rag/*

목표:
- work.txt의 “케이스 상세 탭: AI분석/에이전트 스트림/신뢰도/유사케이스/RAG”가 하드코딩이 아닌 실데이터를 표시하도록 최소 기능을 구현한다.
- 1차는 모델 품질이 아니라 “데이터 파이프/이벤트 스키마/트리거/재현성”을 완성한다.

0) 결론/결정안
- P0: stream 이벤트 스키마를 고정하고, Case 기준으로 재현 가능한 “샘플 스트림”을 제공(SSE로 FE가 확인 가능)
- P1: RAG는 DB evidence_json을 문서화하여 retrieval input으로 쓰고, 유사케이스/신뢰도는 규칙 기반이라도 실데이터로 반환
- P2: 분석 요약은 template 기반(규칙) → 추후 LLM 교체 가능 구조

Assumptions: FE는 SSE hook(useSynapseAgentStream)과 caseId 기반 탭 API를 호출한다.
Open Questions: Aura 쪽에서 case keys(bukrs/belnr/gjahr)를 조회할 “source of truth”(BE API or DB 직접 접근)가 확정인지.
Default: LLM 호출 실패/미설정 시에도 “규칙 기반 fallback”으로 결과를 제공(빈 화면 금지).

1) 구현 범위(In/Out)
IN(P0)
- Case stream endpoint: /api/aura/cases/{caseId}/stream (SSE)
- event schema: event_type, case_id, step_id, message, ts, level, payload(evidence refs)
- replay: Last-Event-ID 지원 + 최근 N개 이벤트 재전송
- observability: trace_id/case_id/tenant_id/user_id 일관 포함

IN(P1)
- RAG evidence endpoint: /api/aura/cases/{caseId}/rag/evidence
  - 입력: case_id로 BE에서 keys 조회(권장) 또는 Aura DB에서 조회(차선)
  - 출력: evidence items(list) + citations(출처 키/필드)
- Similar: /api/aura/cases/{caseId}/similar (규칙 기반: same vendor/amount range/time range)
- Confidence: /api/aura/cases/{caseId}/confidence (score breakdown: rule contributions)

IN(P2)
- Analysis summary: /api/aura/cases/{caseId}/analysis (template+facts)
- HITL 연계: 승인 전 자동 실행 금지(analysis는 read-only)

OUT
- 완전 자율조치/외부 시스템 실시간 연동
- 모델 품질/프롬프트 튜닝 고도화(별도 단계)

2) API 스펙(요약 OpenAPI 스니펫)
paths:
  /api/aura/cases/{caseId}/stream:
    get:
      summary: Case agent stream (SSE)
      parameters:
        - in: header
          name: X-Tenant-ID
          required: true
          schema: { type: string }
        - in: path
          name: caseId
          required: true
          schema: { type: string }
        - in: header
          name: Last-Event-ID
          required: false
          schema: { type: string }
      responses:
        "200":
          description: text/event-stream
  /api/aura/cases/{caseId}/analysis:
    get: { summary: Case analysis summary, responses: { "200": { description: OK } } }
  /api/aura/cases/{caseId}/confidence:
    get: { summary: Case confidence breakdown, responses: { "200": { description: OK } } }
  /api/aura/cases/{caseId}/similar:
    get: { summary: Similar cases, responses: { "200": { description: OK } } }
  /api/aura/cases/{caseId}/rag/evidence:
    get: { summary: RAG evidence list, responses: { "200": { description: OK } } }

3) 이벤트 스키마(고정)
- SSE event:
  - id: <monotonic id>
  - event: "agent.step" | "agent.note" | "agent.error"
  - data:
    {
      "tenantId": "1",
      "caseId": "CS-85114",
      "traceId": "...",
      "ts": "2026-02-06T...",
      "level": "INFO",
      "stepId": "extract-evidence",
      "message": "Extracted 3 evidence items",
      "payload": { "evidenceIds": ["EV-1","EV-2"], "keys": {"bukrs":"1000","belnr":"...","gjahr":"2024"} }
    }

4) 구현 지시(세부)
- Stream 저장소:
  - 최소: in-memory ring buffer(caseId별 최근 N개) + Last-Event-ID replay
  - 운영: DB 또는 Redis 스트림(2차)
- Trigger:
  - P0: “case detail 조회 시 stream session 생성” 또는 “manual trigger endpoint” 둘 중 1개
  - Default(권장): manual trigger endpoint 추가(테스트 재현성)
    POST /api/aura/cases/{caseId}/stream/trigger  (P0 전용, admin 권한)
- RAG evidence:
  - P1에서 evidence_json을 정규화: [{sourceTable, keys, field, value, confidence?}]
  - citations는 최소한 “source keys”를 포함

5) DoD(완료 조건)
- FE에서 케이스 상세 → Stream 탭 열면 3~5개 이벤트가 실시간 표시(또는 trigger 후 표시)
- Last-Event-ID로 새로고침해도 이벤트가 이어서 보임
- rag evidence: 3개 이상(없으면 empty state 명확)
- confidence/similar: 규칙 기반이라도 실데이터로 1개 이상

6) 테스트 방법
- curl:
  - curl -N -H "X-Tenant-ID:1" "http://localhost:xxxx/api/aura/cases/CS-85114/stream"
  - (trigger가 있으면) curl -X POST -H "X-Tenant-ID:1" "http://.../stream/trigger"
- FE:
  - Case Detail → Stream 탭에서 이벤트 표시 캡처
  - RAG/Similar/Confidence 탭 각각 1개 이상 데이터 표시 캡처
